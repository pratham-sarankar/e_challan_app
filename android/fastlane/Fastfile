# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do
  desc "Clean the build artifacts"
  lane :clean do
    # Clean project
    sh "flutter clean"

    # Get dependencies
    sh "flutter pub get"
  
    UI.message("✅ Project cleaned and dependencies fetched")
  end

  desc "Build release APK for a specific flavor"
  lane :build_release do |options|
    flavor = options[:flavor] || "production"

    # Build the release APK for the specified flavor
    # Flutter will generate APKs at: build/app/outputs/flutter-apk/app-{flavor}-release.apk
    sh "flutter build apk --release --flavor #{flavor}"

    UI.message("✅ APK built successfully for #{flavor} flavor")
    UI.message("   Location: build/app/outputs/flutter-apk/app-#{flavor}-release.apk")
  end

  desc "Build release APKs for all flavors (development and production)"
  lane :build_all_flavors do
    # First, clean the project
    clean
    # Build development flavor APK
    # This creates: build/app/outputs/flutter-apk/app-development-release.apk
    build_release(flavor: "development")
    
    # Build production flavor APK
    # This creates: build/app/outputs/flutter-apk/app-production-release.apk
    build_release(flavor: "production")
    
    UI.success("✅ All flavor APKs built successfully!")
    UI.message("   Development APK: build/app/outputs/flutter-apk/app-development-release.apk")
    UI.message("   Production APK: build/app/outputs/flutter-apk/app-production-release.apk")
  end

  desc "Distribute APK using Firebase App Distribution"
  lane :distribute_apk do |options|
    flavor = options[:flavor] || "production"

    # Use fixed Firebase App ID per flavor
    if flavor == "development"
      app_id = "1:995006198955:android:3a34675b99a93fef34f3ee"
    else
      app_id = "1:995006198955:android:3d3860973054a06e34f3ee"
    end

    UI.message("Distributing #{flavor} APK to Firebase app: #{app_id}")

    firebase_app_distribution(
      app: app_id,
      android_artifact_type: "APK",
      android_artifact_path: "../build/app/outputs/flutter-apk/app-#{flavor}-release.apk",
      groups: "internal-testers",
      service_credentials_file: "./serviceAccountKey.json"
    )
  end

  desc "Build and distribute release APK for a specific flavor"
  lane :deploy_apk do |options|
    flavor = options[:flavor] || "production"
    clean
    build_release(flavor: flavor)
    distribute_apk(flavor: flavor)
  end

  desc "Build and distribute APKs for all flavors"
  lane :deploy_all_flavors do
    # First, clean the project
    clean

    # Build all flavors first
    build_all_flavors
    
    # Distribute development flavor
    distribute_apk(flavor: "development")
    
    # Distribute production flavor
    distribute_apk(flavor: "production")
    
    UI.success("✅ All flavors built and distributed successfully!")
  end

end
